# 機能設計書

## システムアーキテクチャ

### 全体構成
```
┌─────────────────────────────────────────────────┐
│                   クライアント層                    │
├─────────────────┬───────────────┬─────────────────┤
│   Webブラウザ    │  Chrome拡張   │  モバイルアプリ  │
│  (React SPA)    │   (将来)      │    (将来)       │
└────────┬────────┴───────┬───────┴────────┬────────┘
         │                 │                │
         └─────────────────┼────────────────┘
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────┐
│                    API Gateway                  │
│                 (認証・ルーティング)              │
└─────────────────────────┬───────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────┐
│                  アプリケーション層               │
├─────────────────┬───────────────┬─────────────────┤
│   認証サービス   │  タスクサービス │  同期サービス   │
└─────────────────┴───────┬───────┴─────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────┐
│                    データ層                      │
├─────────────────┬───────────────┬─────────────────┤
│   ユーザーDB    │   タスクDB     │   セッションDB  │
└─────────────────┴───────────────┴─────────────────┘
```

## 機能別設計

### 1. タスク管理機能

#### データモデル
```typescript
interface Task {
  id: string;           // UUID
  userId: string;       // ユーザーID
  content: string;      // タスク内容
  completed: boolean;   // 完了フラグ
  order: number;        // 表示順序
  createdAt: Date;      // 作成日時
  updatedAt: Date;      // 更新日時
}

interface User {
  id: string;           // UUID
  email: string;        // メールアドレス
  passwordHash: string; // パスワードハッシュ
  createdAt: Date;      // 作成日時
}
```

#### API設計
```
GET    /api/tasks          - タスク一覧取得
POST   /api/tasks          - タスク作成
PUT    /api/tasks/:id      - タスク更新
DELETE /api/tasks/:id      - タスク削除
PUT    /api/tasks/reorder  - タスク並び替え
```

### 2. 認証機能

#### 認証フロー
```
1. ユーザー登録
   → メール/パスワード送信
   → アカウント作成
   → JWTトークン発行

2. ログイン
   → メール/パスワード送信
   → 認証確認
   → JWTトークン発行

3. 認証確認
   → リクエストヘッダーのトークン検証
   → ユーザー情報取得
```

#### API設計
```
POST /api/auth/register - ユーザー登録
POST /api/auth/login    - ログイン
POST /api/auth/logout   - ログアウト
GET  /api/auth/me       - 現在のユーザー情報取得
```

### 3. リアルタイム同期機能

#### 同期方式
- WebSocket接続による双方向通信
- 楽観的UI更新（Optimistic UI）
- コンフリクト解決: Last Write Wins方式

#### イベント設計
```typescript
// クライアント → サーバー
interface ClientEvents {
  'task:create': { content: string };
  'task:update': { id: string; updates: Partial<Task> };
  'task:delete': { id: string };
  'task:reorder': { taskId: string; newOrder: number };
}

// サーバー → クライアント
interface ServerEvents {
  'task:created': { task: Task };
  'task:updated': { task: Task };
  'task:deleted': { id: string };
  'task:reordered': { tasks: Task[] };
  'sync:conflict': { message: string };
}
```

## UI/UX設計

### 画面構成

#### メイン画面（タスクリスト）
```
┌─────────────────────────────────────┐
│  [ロゴ]  SimpleTasks    [ログアウト] │ ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 新しいタスクを入力...        │   │ ← タスク入力欄
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ ☐ タスク1              [×] │   │ ← タスクアイテム
│  ├─────────────────────────────┤   │    (ドラッグ可能)
│  │ ☑ タスク2              [×] │   │
│  ├─────────────────────────────┤   │
│  │ ☐ タスク3              [×] │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

#### ログイン画面
```
┌─────────────────────────────────────┐
│                                     │
│         SimpleTasks                 │
│                                     │
│     ┌─────────────────────┐        │
│     │ メールアドレス       │        │
│     └─────────────────────┘        │
│                                     │
│     ┌─────────────────────┐        │
│     │ パスワード          │        │
│     └─────────────────────┘        │
│                                     │
│     [ログイン]  [新規登録]          │
│                                     │
└─────────────────────────────────────┘
```

### インタラクション設計

#### タスク追加
1. 入力欄をクリック/タップ
2. テキスト入力
3. Enter押下 or 追加ボタンクリック
4. タスクがリストの最上部に追加
5. 入力欄がクリアされ、フォーカス維持

#### タスク並び替え
1. タスクを長押し/ドラッグ開始
2. ドラッグ中は半透明表示
3. 移動先にドロップ
4. アニメーション付きで位置変更
5. 自動保存

#### タスク完了
1. チェックボックスをクリック
2. チェックマーク表示
3. テキストに取り消し線
4. 自動保存

## セキュリティ設計

### 認証・認可
- JWT（JSON Web Token）によるステートレス認証
- トークン有効期限: 7日間
- リフレッシュトークン実装

### データ保護
- HTTPS通信の強制
- パスワードのbcryptハッシュ化
- SQLインジェクション対策
- XSS対策（入力値のサニタイズ）
- CSRF対策（トークン検証）

### レート制限
- API呼び出し: 100リクエスト/分
- ログイン試行: 5回/10分

## パフォーマンス設計

### フロントエンド最適化
- コード分割（Code Splitting）
- 遅延読み込み（Lazy Loading）
- Service Workerによるキャッシュ
- 仮想スクロール（大量タスク対応）

### バックエンド最適化
- データベースインデックス設定
- N+1問題の回避
- Redis によるセッションキャッシュ
- CDNによる静的ファイル配信

### リアルタイム同期最適化
- デバウンス処理（入力中の過剰な同期を防ぐ）
- バッチ処理（複数の変更をまとめて送信）
- 差分同期（変更部分のみ送信）